<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Medical System</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
        }

        .container {
            max-width: 600px;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-bottom: 20px;
        }

        input, select {
            width: 80%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .patient-data, .audit-logs {
            margin-top: 20px;
            text-align: left;
        }

        .hidden {
            display: none;
        }

        .error {
            color: red;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 8px 12px;
            text-align: left;
        }

        table th {
            background-color: #f2f2f2;
        }

        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

    </style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar" style="height: 100%; width: 250px; position: fixed; top: 0; left: 0; background-color: #2c3e50; color: white; padding: 20px 0;">
    <div style="text-align: center; padding: 20px;">
        <img src="logo.jpg" alt="Logo" style="width: 50px; height: 50px;">
        <h3 style="margin-top: 10px; font-size: 18px;">Medical Dashboard</h3>
    </div>
    <ul style="list-style: none; padding: 0;">
        <li style="padding: 15px 20px; border-bottom: 1px solid #34495e;">
            <a href="dashboard.html" style="color: white; text-decoration: none; font-size: 16px; display: flex; align-items: center;">
                <i class="fas fa-tachometer-alt" style="margin-right: 10px;"></i> Dashboard
            </a>
        </li>
        <li style="padding: 15px 20px; border-bottom: 1px solid #34495e;">
            <a href="addpatients.html" style="color: white; text-decoration: none; font-size: 16px; display: flex; align-items: center;">
                <i class="fas fa-user-plus" style="margin-right: 10px;"></i> Add Patients
            </a>
        </li>
        <li style="padding: 15px 20px; border-bottom: 1px solid #34495e;">
            <a href="appointment.html" style="color: white; text-decoration: none; font-size: 16px; display: flex; align-items: center;">
                <i class="fas fa-calendar-check" style="margin-right: 10px;"></i> Appointment
            </a>
        </li>
        <li style="padding: 15px 20px; border-bottom: 1px solid #34495e;">
            <button onclick="Logout()" style="width: 100%; background-color: #e74c3c; color: white; padding: 10px; border: none; text-align: left; font-size: 16px; cursor: pointer;">
                <i class="fas fa-sign-out-alt" style="margin-right: 10px;"></i> Log Out
            </button>
        </li>
    </ul>
</div>



    <div class="container">
        <h2>Admin Dashboard</h2>
        <p id="userInfo">Loading...</p>
  
        <!-- Role Selection (Only for login-based access) -->
        <label for="roleSelect">Select Role:</label>
        <select id="roleSelect" onchange="checkRole()">
            <option value="Administrator">Administrator</option>
            <option value="Medical Director">Medical Director</option>
        </select>

        <!-- Search Patient -->
        <input type="text" id="searchInput" placeholder="Enter RFID or Patient Name">
        <button onclick="searchPatient()">Search</button>
        <p class="error" id="error-message"></p>

        <!-- Patient Details -->
        <div class="patient-data" id="patientData"></div>

        <!-- Audit Logs (Visible only to Medical Directors) -->
        <div class="audit-logs hidden" id="auditLogs">
            <h3>Audit Logs</h3>
            <button onclick="loadAuditLogs()">View Logs</button>

            <!-- Audit Logs Table -->
            <table id="logsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>RFID</th>
                    </tr>
                </thead>
                <tbody id="logsBody">
                    <!-- Logs will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        window.onload = function() {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                window.location.href = "index.html"; // Redirect to login if not logged in
            }
        };

        // Logout function
        function Logout() {
            sessionStorage.removeItem('loggedInUser');
            window.location.href = "index.html"; // Redirect to login after logout
        }

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyC_2VC44krjU72qErcedFWgCiTCexkOlT4",
            authDomain: "rava-medical.firebaseapp.com",
            databaseURL: "https://rava-medical-default-rtdb.firebaseio.com",
            projectId: "rava-medical",
            storageBucket: "rava-medical.firebasestorage.app",
            messagingSenderId: "980529397374",
            appId: "1:980529397374:web:38f6d1574429b5f18f222f",
            measurementId: "G-0YLPHT10YN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentUserRole = 'Administrator';  // Default to Administrator

        // Simulate user login
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                currentUserRole = user.role || 'Administrator'; // You should set user's role on login
                updateUIBasedOnRole(currentUserRole);
            } else {
                // Handle user not logged in
                console.log('No user logged in');
            }
        });

        // Update the UI based on the user's role
        function updateUIBasedOnRole(role) {
            const roleSelect = document.getElementById('roleSelect');
            const auditLogsDiv = document.getElementById('auditLogs');
            
            if (role === "Administrator") {
                // Hide Audit Logs for Admin
                auditLogsDiv.classList.add('hidden');
                roleSelect.value = 'Administrator';
            } else if (role === "Medical Director") {
                // Show Audit Logs for Medical Director
                auditLogsDiv.classList.remove('hidden');
                roleSelect.value = 'Medical Director';
            }
        }

        function checkRole() {
            const role = document.getElementById("roleSelect").value;
            const auditLogsDiv = document.getElementById("auditLogs");

            if (role === "Medical Director") {
                auditLogsDiv.classList.remove("hidden");
            } else {
                auditLogsDiv.classList.add("hidden");
            }
        }

        function searchPatient() {
            const searchInput = document.getElementById('searchInput').value.trim();
            const patientDataDiv = document.getElementById('patientData');
            const errorMessage = document.getElementById('error-message');

            patientDataDiv.innerHTML = "";
            errorMessage.innerText = "";

            if (searchInput === "") {
                errorMessage.innerText = "Please enter an RFID or patient name.";
                return;
            }

            database.ref("patients/" + searchInput).once("value", (snapshot) => {
                if (snapshot.exists()) {
                    displayPatientData(snapshot.val());
                    logAction("Viewed patient record", searchInput);
                } else {
                    searchByName(searchInput);
                }
            });
        }

        function searchByName(name) {
            const patientDataDiv = document.getElementById('patientData');
            const errorMessage = document.getElementById('error-message');

            database.ref("patients").once("value", (snapshot) => {
                let found = false;

                snapshot.forEach((childSnapshot) => {
                    const patient = childSnapshot.val();
                    if (patient.administrative_data.first_name.toLowerCase() === name.toLowerCase() ||
                        patient.administrative_data.last_name.toLowerCase() === name.toLowerCase()) {
                        displayPatientData(patient);
                        logAction("Viewed patient record", childSnapshot.key);
                        found = true;
                    }
                });

                if (!found) {
                    errorMessage.innerText = "Patient not found.";
                }
            });
        }

        function displayPatientData(patient) {
            const patientDataDiv = document.getElementById('patientData');

            patientDataDiv.innerHTML = `
                <h3>Patient Details</h3>
                <table border="1" cellpadding="10" cellspacing="0" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th>Field</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Name</strong></td>
                            <td>${patient.administrative_data.first_name} ${patient.administrative_data.last_name}</td>
                        </tr>
                        <tr>
                            <td><strong>Age</strong></td>
                            <td>${patient.administrative_data.age}</td>
                        </tr>
                        <tr>
                            <td><strong>Gender</strong></td>
                            <td>${patient.administrative_data.gender}</td>
                        </tr>
                        <tr>
                            <td><strong>Blood Group</strong></td>
                            <td>${patient.administrative_data.blood_group_type} ${patient.administrative_data.rhesus_factor}</td>
                        </tr>
                        <tr>
                            <td><strong>Chronic Conditions</strong></td>
                            <td>${patient.medical_data.chronic_conditions}</td>
                        </tr>
                        <tr>
                            <td><strong>Allergies</strong></td>
                            <td>${patient.medical_data.allergies}</td>
                        </tr>
                        <tr>
                            <td><strong>Medical History</strong></td>
                            <td>${patient.medical_data.medical_history}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function logAction(action, patientID) {
            const timestamp = new Date().toISOString();
            const user = "admin1"; // This would be dynamic
            const role = currentUserRole;

            database.ref("audit_logs").push({
                timestamp: timestamp,
                user: user,
                role: role,
                action: action,
                affected_data: patientID
            });
        }

        function loadAuditLogs() {
            const logsBody = document.getElementById("logsBody");
            logsBody.innerHTML = ""; // Clear any previous logs

            database.ref("audit_logs").once("value", (snapshot) => {
                snapshot.forEach((logSnapshot) => {
                    const log = logSnapshot.val();
                    const row = document.createElement("tr");

                    row.innerHTML = `
                        <td>${log.timestamp}</td>
                        <td>${log.user}</td>
                        <td>${log.action}</td>
                        <td>${log.affected_data}</td>
                    `;

                    logsBody.appendChild(row);
                });
            });
        }
    </script>

</body>
</html>
